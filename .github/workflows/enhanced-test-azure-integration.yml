name: Enhanced Test Suite with Azure Integration

on:
  push:
    branches: [ master, develop ]
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches: [ master ]

env:
  NODE_VERSION: '16'
  AZURE_STATIC_WEB_APPS_API_TOKEN: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_HAPPY_FIELD_007F63B03 }}

jobs:
  # Pre-deployment testing
  pre-deployment-tests:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    runs-on: ubuntu-latest
    name: Pre-Deployment Tests
    
    outputs:
      test-results: ${{ steps.test-summary.outputs.results }}
      coverage-threshold: ${{ steps.coverage-check.outputs.meets-threshold }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: true
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: nav-app/package-lock.json
    
    - name: Install dependencies
      working-directory: nav-app
      run: npm ci --legacy-peer-deps
    
    - name: Run linting
      working-directory: nav-app
      run: npm run lint
      continue-on-error: true
    
    - name: Run unit tests with coverage
      working-directory: nav-app
      run: npm run test:ci
    
    - name: Check coverage threshold
      id: coverage-check
      working-directory: nav-app
      run: |
        COVERAGE=$(grep -oP '(?<=Lines\s+:\s)\d+(?=\.\d+%)' coverage/nav-app/lcov-report/index.html || echo "0")
        echo "Coverage: $COVERAGE%"
        if [ "$COVERAGE" -ge 75 ]; then
          echo "meets-threshold=true" >> $GITHUB_OUTPUT
        else
          echo "meets-threshold=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      if: always()
      with:
        file: nav-app/coverage/nav-app/lcov.info
        flags: unittests
        name: pre-deployment-coverage
    
    - name: Build application for testing
      working-directory: nav-app
      run: npm run build
      env:
        NPM_CONFIG_LEGACY_PEER_DEPS: true
    
    - name: Test build artifacts
      run: |
        if [ ! -d "nav-app/dist" ]; then
          echo "Build failed - dist directory not found"
          exit 1
        fi
        if [ ! -f "nav-app/dist/index.html" ]; then
          echo "Build failed - index.html not found"
          exit 1
        fi
        echo "Build artifacts verified successfully"
    
    - name: Store build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: nav-app/dist/
        retention-days: 1
    
    - name: Test summary
      id: test-summary
      run: |
        echo "results=success" >> $GITHUB_OUTPUT

  # Azure Static Web Apps deployment (modified from original)
  azure-deployment:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    needs: pre-deployment-tests
    runs-on: ubuntu-latest
    name: Azure Build and Deploy
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: true
    
    - name: Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: build-artifacts
        path: nav-app/dist/
    
    - name: Deploy to Azure Static Web Apps
      id: builddeploy
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ env.AZURE_STATIC_WEB_APPS_API_TOKEN }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: "upload"
        app_location: "/nav-app"
        api_location: "api"
        output_location: "dist"
        skip_app_build: true  # We already built in pre-deployment-tests
      env:
        NPM_CONFIG_LEGACY_PEER_DEPS: true

  # Post-deployment testing
  post-deployment-tests:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    needs: [pre-deployment-tests, azure-deployment]
    runs-on: ubuntu-latest
    name: Post-Deployment Tests
    
    strategy:
      matrix:
        test-suite: [e2e-cypress, cross-browser-selenium, performance-playwright]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: nav-app/package-lock.json
    
    - name: Install dependencies
      working-directory: nav-app
      run: npm ci --legacy-peer-deps
    
    - name: Wait for deployment
      run: |
        echo "Waiting for Azure deployment to be ready..."
        sleep 60  # Give Azure time to deploy
    
    - name: Run Cypress E2E tests
      if: matrix.test-suite == 'e2e-cypress'
      working-directory: nav-app
      run: |
        npx cypress run --browser chrome --headless
      env:
        CYPRESS_BASE_URL: https://happy-field-007f63b03.azurestaticapps.net
      continue-on-error: true
    
    - name: Run cross-browser tests
      if: matrix.test-suite == 'cross-browser-selenium'
      working-directory: nav-app
      run: |
        # Start Selenium Grid
        docker run -d --name selenium-hub -p 4444:4444 selenium/hub:4.15.0
        docker run -d --name selenium-chrome --link selenium-hub:hub selenium/node-chrome:4.15.0
        docker run -d --name selenium-firefox --link selenium-hub:hub selenium/node-firefox:4.15.0
        
        # Wait for grid to be ready
        npx wait-on http://localhost:4444/wd/hub --timeout 60000
        
        # Run tests
        npm run test:selenium:grid
      env:
        SELENIUM_HUB: http://localhost:4444/wd/hub
        CYPRESS_BASE_URL: https://happy-field-007f63b03.azurestaticapps.net
      continue-on-error: true
    
    - name: Run performance tests
      if: matrix.test-suite == 'performance-playwright'
      working-directory: nav-app
      run: |
        npx playwright install chromium
        npm run test:performance
      env:
        BASE_URL: https://happy-field-007f63b03.azurestaticapps.net
      continue-on-error: true
    
    - name: Upload test artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ${{ matrix.test-suite }}-results
        path: |
          nav-app/cypress/screenshots/
          nav-app/cypress/videos/
          nav-app/test-results/
          nav-app/playwright-report/

  # Security and accessibility scanning
  security-accessibility-scan:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    needs: azure-deployment
    runs-on: ubuntu-latest
    name: Security & Accessibility Scan
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'
    
    - name: Setup Node.js for npm audit
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: nav-app/package-lock.json
    
    - name: Install dependencies
      working-directory: nav-app
      run: npm ci --legacy-peer-deps
    
    - name: Run npm audit
      working-directory: nav-app
      run: npm audit --audit-level moderate
      continue-on-error: true
    
    - name: Install axe-core for accessibility testing
      run: npm install -g @axe-core/cli
    
    - name: Run accessibility tests on deployed site
      run: |
        axe https://happy-field-007f63b03.azurestaticapps.net --exit --reporter json --outputFile accessibility-results.json
      continue-on-error: true
    
    - name: Upload accessibility results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: accessibility-results
        path: accessibility-results.json

  # Docker testing (for local development verification)
  docker-verification:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    runs-on: ubuntu-latest
    name: Docker Verification
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build and test Docker image
      run: |
        # Build test stage
        docker build --target test -t attack-navigator:test .
        
        # Build production stage
        docker build --target production -t attack-navigator:prod .
        
        # Test production image
        docker run -d --name test-container -p 4200:4200 attack-navigator:prod
        
        # Wait for container to start
        sleep 30
        
        # Test health check
        curl -f http://localhost:4200 || exit 1
        
        # Cleanup
        docker stop test-container
        docker rm test-container

  # Close pull request job (from original workflow)
  close-pull-request:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    name: Close Pull Request
    
    steps:
    - name: Close Pull Request
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ env.AZURE_STATIC_WEB_APPS_API_TOKEN }}
        action: "close"

  # Final test summary and reporting
  test-summary-report:
    if: always() && (github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed'))
    needs: [pre-deployment-tests, azure-deployment, post-deployment-tests, security-accessibility-scan, docker-verification]
    runs-on: ubuntu-latest
    name: Test Summary Report
    
    steps:
    - name: Generate Test Report
      run: |
        echo "# ?? Test Summary Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Test Results Overview" >> $GITHUB_STEP_SUMMARY
        echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Pre-Deployment Tests | ${{ needs.pre-deployment-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Azure Deployment | ${{ needs.azure-deployment.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Post-Deployment Tests | ${{ needs.post-deployment-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Security & Accessibility | ${{ needs.security-accessibility-scan.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Docker Verification | ${{ needs.docker-verification.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Deployment Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
        echo "- **URL**: https://happy-field-007f63b03.azurestaticapps.net" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Coverage Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Coverage Threshold Met**: ${{ needs.pre-deployment-tests.outputs.coverage-threshold }}" >> $GITHUB_STEP_SUMMARY
    
    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const summary = `
          ## ?? Test Summary for PR #${{ github.event.number }}
          
          | Test Suite | Status |
          |------------|--------|
          | Pre-Deployment Tests | ${{ needs.pre-deployment-tests.result }} |
          | Azure Deployment | ${{ needs.azure-deployment.result }} |
          | Post-Deployment Tests | ${{ needs.post-deployment-tests.result }} |
          | Security & Accessibility | ${{ needs.security-accessibility-scan.result }} |
          | Docker Verification | ${{ needs.docker-verification.result }} |
          
          **Preview URL**: https://happy-field-007f63b03.azurestaticapps.net
          **Coverage Threshold Met**: ${{ needs.pre-deployment-tests.outputs.coverage-threshold }}
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });